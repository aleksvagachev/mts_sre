# Домашняя работа по седьмому модулю

## Отключение узла
1. Описание эксперимента
Выключить узел в кластере patroni(systemctl stop patroni), для оценки времени переключения slave -> master и оценки кластера после переключения.
Используемые инструменты: терминал, grafana, k6(для иметации нагрузки работы сервиса)
2. Ожидаемые результаты
Переключение произойдёт штатно
Время переключения и возврата кластера в нормальное состояние не дольше 10 c
Воемя восстановления работы сервиса не больше 1 мин.
Возврат реплики в работу не влияет на работу сервиса
3. Реальные результаты
В ходе эксперемента, была воссоздана нагрузка на сервис средствами k6, которая эмулировала нагрузку 100 виртуальных пользователей.
Переключение slave -> master средствами patroni происходит мешьше чем за 5 с.
Во время перкдючения наблюдаётся ошибки в работе сервиса. Работаспособность сервиса восстанавливается ~1 мин. 
Ввод упавшей реплики в работу, не приводит к ошибкам функционирования сервиса. 
Наблюдаемые результаты можно увидеть на следующих дашбордах:  
k6: http://5eca9364-3899-4021-b861-fd4f64e48c6d.mts-gslb.ru/d/ccbb2351-2ae2-462f-ae0e-f2c893ad1028fgdf/k6-prometheus?orgId=1&from=1702211398110&to=1702211851087  
patroni: http://5eca9364-3899-4021-b861-fd4f64e48c6d.mts-gslb.ru/d/rLzu8z_Vkewq/patroni-postgresql?orgId=1&from=1702211400677&to=1702211877824  
4GS: http://5eca9364-3899-4021-b861-fd4f64e48c6d.mts-gslb.ru/d/MhKgQ2nSk/four-golden-signals?from=1702211345113&to=1702211756120&orgId=1  
4. Анализ результатов
Ожидаемые и реальные результаты совпали. Расхождения между результатами идут в сторону более лучших результатов. 
Для более точных цифр результата, можно уменьшить интервал снятия метрик, по которым производился анализ результатов, но по имеющимся результатом понятно, что время восстановления сервиса при смене master <-> slave составляет 1 мин. что соответствует ожиданиям.


## Имитация частичной потери сети
1. Описание эксперимента
При помощи утилиты blade(blade create network drop --source-port 5432 --network-traffic out --timeout 300) имитировать потерю пакетов для оценки поведения кластера patroni при потере пакетов и возобновлении репликации. 
2. Ожидаемые результаты
Кластер функционирует штатно
Удаление пакетов на реплике ни как не сказаллось на работу кластера
Работаспособность сервиса не нарушена
После "восстановления сети" реплика не отстаёт от master
3. Реальные результаты
В ходе эксперемента, была воссоздана нагрузка на сервис средствами k6, которая эмулировала нагрузку 100 виртуальных пользователей.
Удаление пакетов было осуществлено утилитой blade (blade create network drop --source-port 5432 --network-traffic out --timeout 300)
Реплика догналась к нормальному состоянию в течении 1 мин.
Удаление пакетов ни как не сказалось на работу сервиса, так как он не используует реплику в своей работе
Работаспособность сервиса не нарушилась
После "восстановления сети" реплика не отстаёт от master
Наблюдаемые результаты можно увидеть на следующих дашбордах:  
k6: http://5eca9364-3899-4021-b861-fd4f64e48c6d.mts-gslb.ru/d/ccbb2351-2ae2-462f-ae0e-f2c893ad1028fgdf/k6-prometheus?orgId=1&from=1702223940570&to=1702224358024  
patroni: http://5eca9364-3899-4021-b861-fd4f64e48c6d.mts-gslb.ru/d/rLzu8z_Vkewq/patroni-postgresql?orgId=1&from=1702223879346&to=1702224360668  
4GS: http://5eca9364-3899-4021-b861-fd4f64e48c6d.mts-gslb.ru/d/MhKgQ2nSk/four-golden-signals?from=1702223881888&to=1702224243560&orgId=1  
System: http://5eca9364-3899-4021-b861-fd4f64e48c6d.mts-gslb.ru/d/rYdddlPWk1qaz/system-metrics?from=1702223937122&to=1702224421486&orgId=1&var-DS_PROMETHEUS=Vagachev_Aleksandr_Prometheus&var-job=prometheus_node&var-node=10.0.10.3:9100&var-diskdevices=%5Ba-z%5D%2B%7Cnvme%5B0-9%5D%2Bn%5B0-9%5D%2B%7Cmmcblk%5B0-9%5D%2B  
4. Анализ результатов
Ожидаемые и реальные результаты совпали. Расхождений нет. 
Для более детального анализа, нужно больше нагружать сервис и БД, так как с существующей нагрузки сервис невозможно более детально оценить.
Например, нельзя воспроизвести ситуацию, когда master удалил нужный wal файл, а slave не успел его стянуть. 


## Высокая нагрузка на CPU или I/O
1. Описание эксперимента
При помощи утилиты stress-ng(stress-ng --cpu 1 --cpu-method matrixprod --metrics --timeout 120) имитировать высокую утилизацию CPU. 
2. Ожидаемые результаты
Кластер функционирует штатно
Не нарушено функционировании кластера patroni
Работаспособность сервиса не нарушена и нет ухудшения в его работе
3. Реальные результаты
В ходе эксперемента, была воссоздана нагрузка на сервис средствами k6, которая эмулировала нагрузку 100 виртуальных пользователей.
Утилизация CPU осуществлена утилитой stress-ng(stress-ng --cpu 1 --cpu-method matrixprod --metrics --timeout 120)
Реплика работала штатно, никаих изменений не обнаружено
Время ответа сервера увеличилось в два раза, по сравнению с ситуаций когда CPU не утилизировано
Наблюдаемые результаты можно увидеть на следующих дашбордах:  
k6: http://5eca9364-3899-4021-b861-fd4f64e48c6d.mts-gslb.ru/d/ccbb2351-2ae2-462f-ae0e-f2c893ad1028fgdf/k6-prometheus?orgId=1&from=1702227809526&to=1702228038695  
patroni: http://5eca9364-3899-4021-b861-fd4f64e48c6d.mts-gslb.ru/d/rLzu8z_Vkewq/patroni-postgresql?orgId=1&from=1702227783720&to=1702228082328  
4GS: http://5eca9364-3899-4021-b861-fd4f64e48c6d.mts-gslb.ru/d/MhKgQ2nSk/four-golden-signals?from=1702227763327&to=1702228065418&orgId=1  
System: http://5eca9364-3899-4021-b861-fd4f64e48c6d.mts-gslb.ru/d/rYdddlPWk1qaz/system-metrics?from=1702227782830&to=1702228097352&orgId=1&var-DS_PROMETHEUS=Vagachev_Aleksandr_Prometheus&var-job=prometheus_node&var-node=10.0.10.4:9100&var-diskdevices=%5Ba-z%5D%2B%7Cnvme%5B0-9%5D%2Bn%5B0-9%5D%2B%7Cmmcblk%5B0-9%5D%2B  
4. Анализ результатов
Ожидаемые и реальные результаты совпали. Расхождений есть в обработке ответа сервиса. Это связано с тем, что при утилизации CPU в 100% время обработки запросов на БД увеличилось.
Утилизации CPU не повлияло на работу кластера patroni и не привело к переключению master <-> slave


## Тестирование систем мониторинга и оповещения
1. Описание эксперимента
Проверить эффективность системы мониторинга и оповещения. 
2. Ожидаемые результаты
При отключении одного из узлов, сработает триггер о его недоступности
3. Реальные результаты
При выключении экспортёра метрик на одном из серверов etcd триггер сработал в течении одной минуты
Наблюдаемые результаты можно увидеть на следующих дашбордах:  
alertmanager: http://77.105.185.155:9093/#/alerts
4. Анализ результатов
Ожидаемые и реальные результаты совпали.
Стоит рассмотреть время уменьшения срабатывания между происхождением инцидента и его оповещением, для более быстрого реагирования на инциденты.


## Долгосрочная изоляция
Ситуация аналогичная "Имитация частичной потери сети", с возможностью воспроизвести ситуацию, когда master удалил нужный wal файл, а slave не успел его стянуть.
После этого, если wal файлы не архивировались, произойдёт полный синк реплики

